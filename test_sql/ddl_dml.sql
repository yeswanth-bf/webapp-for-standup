CREATE TABLE IF NOT EXISTS REFINED_DEV.BEDROCK.ASSET_RELATIONSHIP_FEED 
(
ID VARCHAR(18), 
PARENT_ID VARCHAR(18), 
TYPE VARCHAR(120), 
CREATED_BY_ID VARCHAR(18), 
CREATED_DATE_UTC TIMESTAMP, 
CREATED_DATE_CST TIMESTAMP, 
IS_DELETED BOOLEAN, 
LAST_MODIFIED_DATE_UTC TIMESTAMP, 
LAST_MODIFIED_DATE_CST TIMESTAMP, 
SYSTEM_MODSTAMP_UTC TIMESTAMP, 
SYSTEM_MODSTAMP_CST TIMESTAMP, 
COMMENT_COUNT NUMBER(38,0), 
LIKE_COUNT NUMBER(38,0), 
TITLE VARCHAR(765), 
BODY VARCHAR(30000), 
LINK_URL VARCHAR(3000), 
IS_RICH_TEXT BOOLEAN, 
RELATED_RECORD_ID VARCHAR(18), 
INSERTED_BY_ID VARCHAR(18), 
BEST_COMMENT_ID VARCHAR(18), 
FIVETRAN_SYNCED_UTC TIMESTAMP, 
FIVETRAN_SYNCED_CST TIMESTAMP,
CURRENT_TIMESTAMP() as REFINED_LOAD_TIME_CST,
PRIMARY KEY (ID)
);

CREATE TABLE IF NOT EXISTS REFINED_DEV.BEDROCK.ASSET_RELATIONSHIP_FEED_ARCHIVE 
(
ID VARCHAR(18), 
PARENT_ID VARCHAR(18), 
TYPE VARCHAR(120), 
CREATED_BY_ID VARCHAR(18), 
CREATED_DATE_UTC TIMESTAMP, 
CREATED_DATE_CST TIMESTAMP, 
IS_DELETED BOOLEAN, 
LAST_MODIFIED_DATE_UTC TIMESTAMP, 
LAST_MODIFIED_DATE_CST TIMESTAMP, 
SYSTEM_MODSTAMP_UTC TIMESTAMP, 
SYSTEM_MODSTAMP_CST TIMESTAMP, 
COMMENT_COUNT NUMBER(38,0), 
LIKE_COUNT NUMBER(38,0), 
TITLE VARCHAR(765), 
BODY VARCHAR(30000), 
LINK_URL VARCHAR(3000), 
IS_RICH_TEXT BOOLEAN, 
RELATED_RECORD_ID VARCHAR(18), 
INSERTED_BY_ID VARCHAR(18), 
BEST_COMMENT_ID VARCHAR(18), 
FIVETRAN_SYNCED_UTC TIMESTAMP, 
FIVETRAN_SYNCED_CST TIMESTAMP,
CURRENT_TIMESTAMP() as REFINED_LOAD_TIME_CST,
PRIMARY KEY (ID,REFINED_LOAD_TIME_CST)
);

MERGE INTO REFINED_DEV.BEDROCK.ASSET_RELATIONSHIP_FEED tgt USING 
(
SELECT
ID,
PARENT_ID,
TYPE,
CREATED_BY_ID,
CREATED_DATE AS CREATED_DATE_UTC,
CONVERT_TIMESHOT('UTC', 'America/Chicago', CREATED_DATE) AS CREATED_DATE_CST,
IS_DELETED,
LAST_MODIFIED_DATE AS LAST_MODIFIED_DATE_UTC,
CONVERT_TIMESHOT('UTC', 'America/Chicago', LAST_MODIFIED_DATE) AS LAST_MODIFIED_DATE_CST,
SYSTEM_MODSTAMP AS SYSTEM_MODSTAMP_UTC,
CONVERT_TIMESHOT('UTC', 'America/Chicago', SYSTEM_MODSTAMP) AS SYSTEM_MODSTAMP_CST,
COMMENT_COUNT,
LIKE_COUNT,
TITLE,
BODY,
LINK_URL,
IS_RICH_TEXT,
RELATED_RECORD_ID,
INSERTED_BY_ID,
BEST_COMMENT_ID,
_FIVETRAN_SYNCED AS FIVETRAN_SYNCED_UTC,
CONVERT_TIMESHOT('UTC', 'America/Chicago', _FIVETRAN_SYNCED) AS FIVETRAN_SYNCED_CST
FROM RAW_DEV.BEDROCK.ASSET_RELATIONSHIP_FEED
WHERE _FIVETRAN_SYNCED > (
SELECT nvl(max(FIVETRAN_SYNCED_UTC), to_timestamp('2000-01-01'))
FROM REFINED_DEV.BEDROCK.ASSET_RELATIONSHIP_FEED
)
WHEN MATCHED THEN UPDATE
SET
tgt.ID = src.ID,
tgt.PARENT_ID = src.PARENT_ID,
tgt.TYPE = src.TYPE,
tgt.CREATED_BY_ID = src.CREATED_BY_ID,
tgt.CREATED_DATE_UTC  = src.CREATED_DATE_UTC,
tgt.CREATED_DATE_CST  = src.CREATED_DATE_CST,
tgt.IS_DELETED = src.IS_DELETED,
tgt.LAST_MODIFIED_DATE_UTC  = src.LAST_MODIFIED_DATE_UTC,
tgt.LAST_MODIFIED_DATE_CST  = src.LAST_MODIFIED_DATE_CST,
tgt.SYSTEM_MODSTAMP_UTC  = src.SYSTEM_MODSTAMP_UTC,
tgt.SYSTEM_MODSTAMP_CST  = src.SYSTEM_MODSTAMP_CST,
tgt.COMMENT_COUNT = src.COMMENT_COUNT,
tgt.LIKE_COUNT = src.LIKE_COUNT,
tgt.TITLE = src.TITLE,
tgt.BODY = src.BODY,
tgt.LINK_URL = src.LINK_URL,
tgt.IS_RICH_TEXT = src.IS_RICH_TEXT,
tgt.RELATED_RECORD_ID = src.RELATED_RECORD_ID,
tgt.INSERTED_BY_ID = src.INSERTED_BY_ID,
tgt.BEST_COMMENT_ID = src.BEST_COMMENT_ID,
tgt.FIVETRAN_SYNCED_UTC  = src.FIVETRAN_SYNCED_UTC,
tgt.FIVETRAN_SYNCED_CST  = src.FIVETRAN_SYNCED_CST
WHEN NOT MATCHED THEN INSERT (
ID,
PARENT_ID,
TYPE,
CREATED_BY_ID,
CREATED_DATE_UTC,
CREATED_DATE_CST,
IS_DELETED,
LAST_MODIFIED_DATE_UTC,
LAST_MODIFIED_DATE_CST,
SYSTEM_MODSTAMP_UTC,
SYSTEM_MODSTAMP_CST,
COMMENT_COUNT,
LIKE_COUNT,
TITLE,
BODY,
LINK_URL,
IS_RICH_TEXT,
RELATED_RECORD_ID,
INSERTED_BY_ID,
BEST_COMMENT_ID,
FIVETRAN_SYNCED_UTC,
FIVETRAN_SYNCED_CST
)
VALUES (
ID,
PARENT_ID,
TYPE,
CREATED_BY_ID,
CREATED_DATE_UTC,
CREATED_DATE_CST,
IS_DELETED,
LAST_MODIFIED_DATE_UTC,
LAST_MODIFIED_DATE_CST,
SYSTEM_MODSTAMP_UTC,
SYSTEM_MODSTAMP_CST,
COMMENT_COUNT,
LIKE_COUNT,
TITLE,
BODY,
LINK_URL,
IS_RICH_TEXT,
RELATED_RECORD_ID,
INSERTED_BY_ID,
BEST_COMMENT_ID,
FIVETRAN_SYNCED_UTC,
FIVETRAN_SYNCED_CST
);

INSERT INTO REFINED_DEV.BEDROCK.ASSET_RELATIONSHIP_FEED (
ID,
PARENT_ID,
TYPE,
CREATED_BY_ID,
CREATED_DATE_UTC,
CREATED_DATE_CST,
IS_DELETED,
LAST_MODIFIED_DATE_UTC,
LAST_MODIFIED_DATE_CST,
SYSTEM_MODSTAMP_UTC,
SYSTEM_MODSTAMP_CST,
COMMENT_COUNT,
LIKE_COUNT,
TITLE,
BODY,
LINK_URL,
IS_RICH_TEXT,
RELATED_RECORD_ID,
INSERTED_BY_ID,
BEST_COMMENT_ID,
FIVETRAN_SYNCED_UTC,
FIVETRAN_SYNCED_CST
)
SELECT
ID,
PARENT_ID,
TYPE,
CREATED_BY_ID,
CREATED_DATE_UTC,
CREATED_DATE_CST,
IS_DELETED,
LAST_MODIFIED_DATE_UTC,
LAST_MODIFIED_DATE_CST,
SYSTEM_MODSTAMP_UTC,
SYSTEM_MODSTAMP_CST,
COMMENT_COUNT,
LIKE_COUNT,
TITLE,
BODY,
LINK_URL,
IS_RICH_TEXT,
RELATED_RECORD_ID,
INSERTED_BY_ID,
BEST_COMMENT_ID,
FIVETRAN_SYNCED_UTC,
FIVETRAN_SYNCED_CST
FROM
REFINED_DEV.BEDROCK.ASSET_RELATIONSHIP_FEED
WHERE REFINED_LOAD_TIME_CST > (SELECT nvl(max(REFINED_LOAD_TIME_CST), to_timestamp('2000-01-01'))
FROM REFINED_DEV.BEDROCK.ASSET_RELATIONSHIP_FEED );